version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=goff
      - POSTGRES_USER=goff
      - POSTGRES_PASSWORD=goff
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U goff -d goff"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Flag Manager API
  flag-manager-api:
    build: ./flag-manager-api
    ports:
      - "8095:8095"
    volumes:
      - flags-data:/data/flags
    environment:
      - PORT=8095
      - FLAGS_DIR=/data/flags
      - RELAY_PROXY_URL=http://relay-proxy:1031
      - DATABASE_URL=postgres://goff:goff@postgres:5432/goff?sslmode=disable
      - AUTH_ENABLED=false
      # - JWT_ISSUER_URL=http://keycloak:8080/realms/goff
      # - ALLOWED_ORIGINS=http://localhost:4000
      # Git Provider Configuration (uncomment one provider)
      # =================================================
      # Azure DevOps:
      # - GIT_PROVIDER=ado
      # - ADO_ORG_URL=${ADO_ORG_URL}
      # - ADO_PROJECT=${ADO_PROJECT}
      # - ADO_REPOSITORY=${ADO_REPOSITORY}
      # - ADO_PAT=${ADO_PAT}
      # - GIT_BASE_BRANCH=main
      # - GIT_FLAGS_PATH=/flags.yaml
      # =================================================
      # GitLab:
      # - GIT_PROVIDER=gitlab
      # - GITLAB_URL=${GITLAB_URL}
      # - GITLAB_PROJECT_ID=${GITLAB_PROJECT_ID}
      # - GITLAB_TOKEN=${GITLAB_TOKEN}
      # - GIT_BASE_BRANCH=main
      # - GIT_FLAGS_PATH=/flags.yaml
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8095/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GO Feature Flag Relay Proxy
  relay-proxy:
    build: ./go-feature-flag
    ports:
      - "1031:1031"
    volumes:
      - ./relay-proxy-config.yaml:/goff/goff-proxy.yaml:ro
    depends_on:
      flag-manager-api:
        condition: service_healthy
    restart: unless-stopped

  # Frontend UI
  goff-ui:
    build: ./goff-ui
    ports:
      - "4000:4000"
    environment:
      - FLAG_MANAGER_API_URL=http://flag-manager-api:8095
      - NEXT_PUBLIC_FLAG_MANAGER_API_URL=http://localhost:8095
      - RELAY_PROXY_URL=http://relay-proxy:1031
      - NEXT_PUBLIC_RELAY_PROXY_URL=http://localhost:1031
      - DEV_MODE=true
      - AUTH_SECRET=change-this-in-production
    depends_on:
      flag-manager-api:
        condition: service_healthy
      relay-proxy:
        condition: service_started
    restart: unless-stopped

  # Optional: Nginx reverse proxy for SSL termination
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - goff-ui
      - flag-manager-api
    profiles:
      - with-nginx  # Only start with: docker-compose --profile with-nginx up
    restart: unless-stopped

volumes:
  pgdata:
  flags-data:
