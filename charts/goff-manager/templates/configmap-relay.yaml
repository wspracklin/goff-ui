{{- if .Values.relayProxy.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "goff-manager.relayProxy.configMapName" . }}
  namespace: {{ include "goff-manager.namespace" . }}
  labels:
    {{- include "goff-manager.relayProxy.labels" . | nindent 4 }}
data:
  goff-proxy.yaml: |
    # GO Feature Flag Relay Proxy Configuration
    # Generated by Helm chart

    server:
      port: {{ .Values.relayProxy.service.port }}
      host: 0.0.0.0

    {{- if .Values.relayProxy.config.debug }}
    debug: true
    {{- end }}

    # Retriever configuration - fetch flags from Flag Manager API
    retriever:
      kind: http
      url: {{ include "goff-manager.api.internalUrl" . }}/api/flags/raw

    pollingInterval: {{ .Values.relayProxy.config.pollingInterval | default 10000 }}

    {{- if or .Values.relayProxy.authorizedKeys.evaluation .Values.relayProxy.authorizedKeys.admin }}
    # Authorized API keys
    authorizedKeys:
      {{- if .Values.relayProxy.authorizedKeys.evaluation }}
      evaluation:
        {{- range .Values.relayProxy.authorizedKeys.evaluation }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
      {{- if .Values.relayProxy.authorizedKeys.admin }}
      admin:
        {{- range .Values.relayProxy.authorizedKeys.admin }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
    {{- end }}

    # Enable OFREP (OpenFeature Remote Evaluation Protocol)
    enableOFREP: true
{{- end }}
